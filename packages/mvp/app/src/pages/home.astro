---
import Layout from "@/layouts/MainLayout.astro";
import { orgTasks, orgAccounts, orgInfo } from "@/utils/queries";

const { user } = Astro.locals;

if (!user)
  return Astro.redirect("/login");

const greeting = `Welcome back ${user.fullname}`;

const [org, tasks, accounts] = await Promise.all([
  orgInfo.get({ org: user.primary_org }).then(org => org!),
  orgTasks.all({ org: user.primary_org }),
  orgAccounts.all({ org: user.primary_org }),
]);
---

<Layout
  meta={{
    title: "Home",
    description: greeting,
  }}
>
  <div class="pico container">
    <h1>{org.name}</h1>
  </div>
  <section class="pico container">
    <h2>Created tasks</h2>
    <div>
      {
        tasks.map(task => (
          <article class="mx-auto max-w-sm">
            {task.title}
            {task.body && <footer>{task.body}</footer>}
          </article>
        ))
      }
    </div>
  </section>
  <section class="pico container">
    <h2>Accounts</h2>
    {
      accounts.map(account => (
        <article class="mx-auto max-w-sm">
          {account.name}
        </article>
      ))
    }
  </section>
</Layout>
