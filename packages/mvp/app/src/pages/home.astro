---
import { Account, Task, db, eq } from "astro:db";
import Layout from "@/layouts/MainLayout.astro";

const { user } = Astro.locals;

if (!user)
  return Astro.redirect("/login");

const greeting = `Welcome back ${user.fullname}`;

const tasks = await db.select()
  .from(Task)
  .where(eq(Task.author, user.id));

const accounts = user.primary_org && await db.select()
  .from(Account)
  .where(eq(Account.org, user.primary_org));
---

<Layout
  meta={{
    title: "Home",
    description: greeting,
  }}
>
  <section class="pico container">
    <h2>Created tasks</h2>
    <div>
      {
        tasks.map(t => (
          <article class="mx-auto max-w-sm">
            {t.title}
            {t.body && <footer>{t.body}</footer>}
          </article>
        ))
      }
    </div>
  </section>
  {
    accounts && (
      <section class="pico container">
        <h2>Accounts</h2>
        {
          accounts.map(account => (
            <article class="mx-auto max-w-sm">
              {account.name}
              {account.info && <footer>{account.info}</footer>}
            </article>
          ))
        }
      </section>
    )
  }
</Layout>
